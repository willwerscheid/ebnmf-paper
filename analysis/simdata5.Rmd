---
title: NMF analyses of simulated data
author: Jason Willwerscheid and Peter Carbonetto
output:
  workflowr::wflow_html:
    toc: no
    theme: readable
    highlight: textmate
    lib_dir: site_libs
    self_contained: no
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages and some custom functions needed for the
analyses below.

```{r load-pkgs, message=FALSE}
library(R.matlab)
library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(ebnm)
library(flashier)
library(fastTopics)
source("code/swimmer_functions.R")
```

Here we begin by simulating a very basic scenario in which each population corresponds to a single, distinct topic. Each topic has a handful of anchor words. Documents are all of the same size (so no normalization is necessary).

For each scenario, we'll perform a number of NMF decompositions:
1. Vanilla NMF (oracle K)
1. Vanilla NMF (K set too high)
1. EBNMF (NMF initialization with K set too high + backfit)
1. EBNMF (oracle K, greedy) 
1. EBNMF (oracle K, greedy + backfit)
1. EBNMF (Kmax set too high, greedy)
1. EBNMF (Kmax set too high, greedy + backfit)
1. Sparse NMF (oracle K, sparsity set too low)
1. Sparse NMF (oracle K, approximately correct sparsity)
1. Sparse NMF (oracle K, sparsity set too high)
1. Sparse (K set too high, approximately correct sparsity)

Visualization: 3 x 4 grid

```{r sim-data}
n <- 1000
p <- 500
k <- 4

set.seed(1)
L <- matrix(0, nrow = n, ncol = k)
F <- matrix(0, nrow = p, ncol = k)

# Loadings (document-topics):
L[, 1] <- c(rep(1, 250), rep(0, 750))
L[, 2] <- c(rep(0, 250), rep(1, 250), rep(0, 500))
L[, 3] <- c(rep(0, 500), rep(1, 250), rep(0, 250))
L[, 4] <- c(rep(0, 750), rep(1, 250))

F <- matrix(rexp(p * 4), nrow = p, ncol = 4)
F <- apply(F, 2, function(x) x / sum(x))

# Anchor words
n_word_anchors <- 10
F[1:n_word_anchors, 2:4] <- 0
F[(n_word_anchors + 1):(2 * n_word_anchors), c(1, 3, 4)] <- 0
F[(2 * n_word_anchors + 1):(3 * n_word_anchors), c(1, 2, 4)] <- 0
F[(3 * n_word_anchors + 1):(4 * n_word_anchors), 1:3] <- 0

props <- L %*% t(F)
X <- t(apply(props, 1, function(x) rmultinom(1, 2000, x)))

Y <- log1p(X)
F <- F[apply(Y, 2, sum) > 0, ]
Y <- Y[, apply(Y, 2, sum) > 0]
rownames(Y) <- paste0("sample", 1:nrow(Y))
colnames(Y) <- paste0("feature", 1:ncol(Y))

L_grps <- rep(LETTERS[1:4], each = 250)

writeMat("matlab/simdata_scenario1.mat", Y = Y)
```

The "true" loadings matrix $L$ appears as follows:

```{r}
do_structure_plot <- function(LL, kset, title) {
  structure_plot(LL[, kset], grouping = L_grps, gap = 20, 
                 topics = rev(1:ncol(LL)), loadings_order = 1:1000,
                 colors = RColorBrewer::brewer.pal(10, "Set3")) +
    labs(y = "") +
    ggtitle(title) +
    guides(fill = "none", color = "none") +
    # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(axis.text.x = element_blank()) +
    theme(axis.text.y = element_blank()) +
    theme(plot.title.position = "plot")
}
plot_fl <- function(fl, kset, title) {
  LDF <- ldf(fl, type = "f")
  LL <- t(t(LDF$L) * LDF$D)
  do_structure_plot(LL, kset, title)
}
plot_nmf <- function(res, kset, title) {
  Wscale <- sqrt(apply(res$W, 2, function(x) sum(x^2)))
  Hscale <- sqrt(apply(res$H, 1, function(x) sum(x^2)))
  D <- Wscale * Hscale
  LL <- t(t(res$W) / sqrt(Wscale) * sqrt(Hscale))
  do_structure_plot(LL, kset, title)
}

allplots <- list()
allplots[[1]] <- do_structure_plot(L, 1:4, "True")
allplots[[1]]
```

Vanilla NMF with $K = 4$:

```{r}
set.seed(1)
nmf_res <- NNLM::nnmf(Y, k = 4)
allplots[[2]] <- plot_nmf(nmf_res, c(1, 3, 4, 2), "NMF (K = 4)")
allplots[[2]]
```

Vanilla NMF with $K = 8$:

```{r}
set.seed(1)
nmf_res <- NNLM::nnmf(Y, k = 8)
allplots[[3]] <- plot_nmf(nmf_res, c(4, 8, 3, 6, 2, 5, 1, 7), "NMF (K = 8)")
allplots[[3]]
```

EBNMF, initialize from NMF solution ($K = 8$) and backfit:

```{r}
fl_b <- flash_init(Y) |>
  flash_factors_init(list(nmf_res$W, t(nmf_res$H)), ebnm_fn = ebnm_point_exponential) |>
  flash_backfit(maxiter = 5000) |>
  flash_nullcheck()
allplots[[4]] <- plot_fl(fl_b, c(4, 7, 3, 6, 1, 2, 5), "EBNMF, NMF init (K = 8)") 
allplots[[4]]
```

Greedy EBNMF with `Kmax = 4`:

```{r}
fl <- flash(Y, greedy_Kmax = 4, ebnm_fn = ebnm_point_exponential)
allplots[[5]] <- plot_fl(fl, c(2, 4, 3, 1), "Greedy EBNMF (Kmax = 4)")
allplots[[5]]
```

EBNMF with `Kmax = 4`, greedy + backfit:

```{r}
fl_gb <- fl |> 
  flash_backfit() 
allplots[[6]] <- plot_fl(fl_gb, c(2, 4, 3, 1), "Backfit EBNMF (Kmax = 4)") 
allplots[[6]]
```

Greedy EBNMF with `Kmax = 8`:

```{r}
fl <- flash(Y, greedy_Kmax = 8, ebnm_fn = ebnm_point_exponential)
allplots[[7]] <- plot_fl(fl, c(2, 4, 3, 5, 1), "Greedy EBNMF (Kmax = 8)")
allplots[[7]]
```

EBNMF with `Kmax = 8`, greedy + backfit:

```{r}
fl_gb <- fl |> 
  flash_backfit() 
allplots[[8]] <- plot_fl(fl_gb, c(2, 4, 3, 5, 1), "Backfit EBNMF (Kmax = 8)") 
allplots[[8]]
```

Sparse NMF (K = 4) with approximately correct sparsity setting:

```{r}
sparse_nmf <- readMat("matlab/simdata_scenario1_nmf_sW=0.5.mat")
allplots[[10]] <- plot_nmf(sparse_nmf, c(4, 1, 2, 3), "SpNMF (K = 4, good spars)")
allplots[[10]]
```



Sparse NMF (K = 4) with sparsity set too low:

```{r}
sparse_nmf <- readMat("matlab/simdata_scenario1_nmf_sW=0.3.mat")
allplots[[9]] <- plot_nmf(sparse_nmf, c(4, 3, 2, 1), "SpNMF (K = 4, low spars)")
allplots[[9]]
```

Sparse NMF (K = 4) with sparsity set too high:

```{r}
sparse_nmf <- readMat("matlab/simdata_scenario1_nmf_sW=0.6.mat")
allplots[[11]] <- plot_nmf(sparse_nmf, c(4, 1, 2, 3), "SpNMF (K = 4, high spars)")
allplots[[11]]
```

Sparse NMF (K = 8) with approximately correct sparsity setting:

```{r}
sparse_nmf <- readMat("matlab/simdata_scenario1_nmf_k=8.mat")
allplots[[12]] <- plot_nmf(sparse_nmf, c(6, 2, 1, 8, 5, 4, 3, 7), "SpNMF (K = 8, good spars)")
allplots[[12]]
```

All plots:

```{r fig.height=6, fig.width=8}
p <- plot_grid(plotlist = allplots, nrow = 3, ncol = 4)
p
```

