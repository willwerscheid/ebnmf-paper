---
title: NMF analyses of simulated data
author: Jason Willwerscheid and Peter Carbonetto
output:
  workflowr::wflow_html:
    toc: no
    theme: readable
    highlight: textmate
    lib_dir: site_libs
    self_contained: no
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages and some custom functions needed for the
analyses below.

```{r load-pkgs, message=FALSE}
library(R.matlab)
library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(ebnm)
library(flashier)
library(fastTopics)
source("code/swimmer_functions.R")
```

The next simulation features hierarchical (tree-like) relationships. In addition to topics for each of four leaf populations, we have two branch topics and one root topic (so, seven topics). For identifiability we also need anchor documents for each topic; we will make these populations smaller; this will also test the ability of methods to find rarer populations.

```{r sim-data}
n <- 1350
p <- 500
k <- 7

set.seed(1)
L <- matrix(0, nrow = n, ncol = k)
F <- matrix(0, nrow = p, ncol = k)

# Loadings (document-topics):
L[, 7] <- c(rep(1, 1050), rep(0, 300)) # root
L[, 5] <- c(rep(1, 500), rep(0, 550), rep(1, 50), rep(0, 250)) # branch 1
L[, 6] <- c(rep(0, 500), rep(1, 500), rep(0, 100), rep(1, 50), rep(0, 200)) # branch 2
L[, 1] <- c(rep(1, 250), rep(0, 900), rep(1, 50), rep(0, 150)) # leaf 1
L[, 2] <- c(rep(0, 250), rep(1, 250), rep(0, 700), rep(1, 50), rep(0, 100)) # leaf 2
L[, 3] <- c(rep(0, 500), rep(1, 250), rep(0, 500), rep(1, 50), rep(0, 50)) # leaf 3
L[, 4] <- c(rep(0, 750), rep(1, 250), rep(0, 300), rep(1, 50)) # leaf 4

F <- matrix(rexp(p * k), nrow = p, ncol = k)
F <- apply(F, 2, function(x) x / sum(x))

# Anchor words
n_word_anchors <- 10
for (i in 1:k) {
  F[((i - 1) * n_word_anchors + 1):(i * n_word_anchors), setdiff(1:k, i)] <- 0
}

props <- L %*% t(F)
X <- t(apply(props, 1, function(x) rmultinom(1, 2000, x)))

Y <- log1p(X)
F <- F[apply(Y, 2, sum) > 0, ]
Y <- Y[, apply(Y, 2, sum) > 0]
rownames(Y) <- paste0("sample", 1:nrow(Y))
colnames(Y) <- paste0("feature", 1:ncol(Y))

L_grps <- c(rep(LETTERS[1:4], each = 250), rep(LETTERS[5:11], each = 50))

writeMat("matlab/simdata_scenario3.mat", Y = Y)
```

The "true" loadings matrix $L$ appears as follows:

```{r}
do_structure_plot <- function(LL, kset, title) {
  structure_plot(LL[, kset], grouping = L_grps, gap = 20, 
                 topics = rev(1:ncol(LL)), loadings_order = 1:n,
                 colors = RColorBrewer::brewer.pal(10, "Set3")) +
    labs(y = "") +
    ggtitle(title) +
    guides(fill = "none", color = "none") +
    # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(axis.text.x = element_blank()) +
    theme(axis.text.y = element_blank()) +
    theme(plot.title.position = "plot")
}
plot_fl <- function(fl, kset, title) {
  LDF <- ldf(fl, type = "f")
  LL <- t(t(LDF$L) * LDF$D)
  do_structure_plot(LL, kset, title)
}
plot_nmf <- function(res, kset, title) {
  Wscale <- sqrt(apply(res$W, 2, function(x) sum(x^2)))
  Hscale <- sqrt(apply(res$H, 1, function(x) sum(x^2)))
  D <- Wscale * Hscale
  LL <- t(t(res$W) / sqrt(Wscale) * sqrt(Hscale))
  do_structure_plot(LL, kset, title)
}

allplots <- list()
allplots[[1]] <- do_structure_plot(L, 1:7, "True")
allplots[[1]]
```

Vanilla NMF with $K = 7$:

```{r}
set.seed(1)
nmf_res <- NNLM::nnmf(Y, k = 7)
allplots[[2]] <- plot_nmf(nmf_res, c(6, 3, 5, 2, 4, 1, 7), "NMF")
allplots[[2]]
```

Vanilla NMF with $K = 10$:

```{r}
set.seed(1)
nmf_res <- NNLM::nnmf(Y, k = 10)
allplots[[3]] <- plot_nmf(nmf_res, c(1, 7, 5, 6, 10, 9, 4, 3, 2, 8), "NMF")
allplots[[3]]
```

EBNMF, initialize from NMF solution ($K = 10$) and backfit:

```{r}
fl_b <- flash_init(Y) |>
  flash_factors_init(list(nmf_res$W, t(nmf_res$H)), ebnm_fn = ebnm_point_exponential) |>
  flash_backfit(maxiter = 5000) |>
  flash_nullcheck()
allplots[[4]] <- plot_fl(fl_b, c(1, 7, 5, 6, 10, 9, 4, 3, 2, 8), "EBNMF (NMF init)") 
allplots[[4]]
```

Greedy EBNMF with `Kmax = 7`:

```{r}
fl <- flash(Y, greedy_Kmax = 7, ebnm_fn = ebnm_point_exponential)
allplots[[5]] <- plot_fl(fl, c(3, 2, 4, 5, 1), "EBNMF (greedy)")
allplots[[5]]
```

EBNMF with `Kmax = 7`, greedy + backfit:

```{r}
fl_gb7 <- fl |> 
  flash_backfit() 
allplots[[6]] <- plot_fl(fl_gb7, c(3, 2, 4, 5, 1), "EBNMF (backfit)") 
allplots[[6]]
```

EBNMF with `Kmax = 7`, (greedy + backfit) * n:

```{r}
fl_gbgb7 <- fl_gb7 |> 
  flash_greedy(Kmax = 2, ebnm_fn = ebnm_point_exponential) |>
  flash_backfit() 
allplots[[6]] <- plot_fl(fl_gbgb7, c(3, 2, 4, 7, 6, 5, 1), "EBNMF (backfit)") 
allplots[[6]]
```

Greedy EBNMF with `Kmax = 10` yields the same result (only 6 factors are initially fit). But if we add more factors in the subsequent greedy + backfit (no more factors are added by additional greedy + backfit iterations):

```{r}
fl_gbg <- fl_gb7 |> 
  flash_greedy(Kmax = 4, ebnm_fn = ebnm_point_exponential) 
fl_gbgb <- fl_gbg |>
  flash_backfit() 
allplots[[7]] <- plot_fl(fl_gbg, c(3, 8, 4, 7, 2, 5, 1, 6, 9), "EBNMF (greedy)") 
allplots[[7]]
allplots[[8]] <- plot_fl(fl_gbgb, c(3, 8, 4, 7, 2, 5, 1, 6, 9), "EBNMF (backfit)") 
allplots[[8]]
```

Removing the background factor here doesn't work as well:

```{r}
fl_refit <- flash_init(Y) |>
  flash_greedy(Kmax = 10, ebnm_fn = ebnm_point_exponential) |>
  flash_backfit() |>
  flash_factors_remove(kset = 1) |>
  flash_backfit() |>
  flash_greedy(Kmax = 10, ebnm_fn = ebnm_point_exponential) |>
  flash_backfit() |>
  flash_greedy(Kmax = 10, ebnm_fn = ebnm_point_exponential) |>
  flash_backfit()
tmp <- fl_refit |>
  flash_factors_remove(11) # too many to plot, remove factor with smallest PVE
allplots[[9]] <- plot_fl(tmp, c(2, 9, 3, 10, 1, 4, 7, 5, 6, 8), "EBNMF (remove background, refit)") 
allplots[[9]]
```

All plots:

```{r fig.height=6, fig.width=8}
p1 <- plot_grid(plotlist = allplots[c(1, 2, 5, 6)], nrow = 2, ncol = 2)
p1
```


```{r fig.height=6, fig.width=8}
p2 <- plot_grid(plotlist = allplots[c(1, 3, 7, 8, 4, 9)], nrow = 3, ncol = 2)
p2
```

ELBOs:

```{r}
fl_gbgb$elbo
fl_b$elbo
fl_refit$elbo
```

