---
title: NMF analyses of simulated data
author: Jason Willwerscheid and Peter Carbonetto
output:
  workflowr::wflow_html:
    toc: no
    theme: readable
    highlight: textmate
    lib_dir: site_libs
    self_contained: no
---

```{r knitr-opts, include=FALSE}
knitr::opts_chunk$set(comment = "#",collapse = TRUE,results = "hold",
                      fig.align = "center",dpi = 120)
```

First, load the packages and some custom functions needed for the
analyses below.

```{r load-pkgs, message=FALSE}
library(R.matlab)
library(tibble)
library(dplyr)
library(tidyr)
library(ggplot2)
library(cowplot)
library(ebnm)
library(flashier)
library(fastTopics)
source("code/swimmer_functions.R")
```

Next we simulate a more advanced scenario with some overlapping relationships. There are four topics, which for concreteness we call betting, soccer, and basketball. In addition to the three "pure" populations, we add the following mixed populations:

1. Soccer betting (betting + soccer)
2. Basketball betting (betting + basketball)
3. General sports (soccer + basketball)


```{r sim-data}
n <- 1500
p <- 500
k <- 3

set.seed(1)
L <- matrix(0, nrow = n, ncol = k)
F <- matrix(0, nrow = p, ncol = k)

# Loadings (document-topics):
L[, 1] <- c(rep(1, 250), rep(0, 500), rep(1, 500), rep(0, 250))
L[, 2] <- c(rep(0, 250), rep(1, 250), rep(0, 250), rep(1, 250), rep(0, 250), rep(1, 250))
L[, 3] <- c(rep(0, 500), rep(1, 250), rep(0, 250), rep(1, 500))

F <- matrix(rexp(p * k), nrow = p, ncol = k)
F <- apply(F, 2, function(x) x / sum(x))

# Anchor words
n_word_anchors <- 10
F[1:n_word_anchors, 2:3] <- 0
F[(n_word_anchors + 1):(2 * n_word_anchors), c(1, 3)] <- 0
F[(2 * n_word_anchors + 1):(3 * n_word_anchors), 1:2] <- 0

props <- L %*% t(F)
X <- t(apply(props, 1, function(x) rmultinom(1, 2000, x)))

Y <- log1p(X)
F <- F[apply(Y, 2, sum) > 0, ]
Y <- Y[, apply(Y, 2, sum) > 0]
rownames(Y) <- paste0("sample", 1:nrow(Y))
colnames(Y) <- paste0("feature", 1:ncol(Y))

L_grps <- rep(LETTERS[1:6], each = 250)

writeMat("matlab/simdata_scenario2.mat", Y = Y)
```

The "true" loadings matrix $L$ appears as follows:

```{r}
do_structure_plot <- function(LL, kset, title) {
  structure_plot(LL[, kset], grouping = L_grps, gap = 20, 
                 topics = rev(1:ncol(LL)), loadings_order = 1:1500,
                 colors = RColorBrewer::brewer.pal(10, "Set3")) +
    labs(y = "") +
    ggtitle(title) +
    guides(fill = "none", color = "none") +
    # theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(axis.text.x = element_blank()) +
    theme(axis.text.y = element_blank()) +
    theme(plot.title.position = "plot")
}
plot_fl <- function(fl, kset, title) {
  LDF <- ldf(fl, type = "f")
  LL <- t(t(LDF$L) * LDF$D)
  do_structure_plot(LL, kset, title)
}
plot_nmf <- function(res, kset, title) {
  Wscale <- sqrt(apply(res$W, 2, function(x) sum(x^2)))
  Hscale <- sqrt(apply(res$H, 1, function(x) sum(x^2)))
  D <- Wscale * Hscale
  LL <- t(t(res$W) / sqrt(Wscale) * sqrt(Hscale))
  do_structure_plot(LL, kset, title)
}

allplots <- list()
allplots[[1]] <- do_structure_plot(L, 1:3, "True")
allplots[[1]]
```

Vanilla NMF with $K = 3$:

```{r}
set.seed(1)
nmf_res <- NNLM::nnmf(Y, k = 3)
allplots[[2]] <- plot_nmf(nmf_res, c(1, 3, 2), "NMF")
allplots[[2]]
```

Vanilla NMF with $K = 6$:

```{r}
set.seed(1)
nmf_res <- NNLM::nnmf(Y, k = 6)
allplots[[3]] <- plot_nmf(nmf_res, c(6, 4, 3, 1, 2, 5), "NMF")
allplots[[3]]
```

EBNMF, initialize from NMF solution ($K = 6$) and backfit:

```{r}
fl_b <- flash_init(Y) |>
  flash_factors_init(list(nmf_res$W, t(nmf_res$H)), ebnm_fn = ebnm_point_exponential) |>
  flash_backfit(maxiter = 5000) |>
  flash_nullcheck()
allplots[[4]] <- plot_fl(fl_b, c(6, 4, 3, 1, 2, 5), "EBNMF (NMF init)") 
allplots[[4]]
```

Greedy EBNMF with `Kmax = 3`:

```{r}
fl <- flash(Y, greedy_Kmax = 3, ebnm_fn = ebnm_point_exponential)
allplots[[5]] <- plot_fl(fl, c(2, 3, 1), "EBNMF (greedy)")
allplots[[5]]
```

EBNMF with `Kmax = 3`, greedy + backfit:

```{r}
fl_gb3 <- fl |> 
  flash_backfit() 
allplots[[6]] <- plot_fl(fl_gb3, c(2, 3, 1), "EBNMF (backfit)") 
allplots[[6]]
```

Greedy EBNMF with `Kmax = 6`:

```{r}
fl <- flash(Y, greedy_Kmax = 6, ebnm_fn = ebnm_point_exponential)
allplots[[7]] <- plot_fl(fl, c(2:4, 1), "EBNMF (greedy)")
allplots[[7]]
```

EBNMF with `Kmax = 6`, greedy + backfit:

```{r}
fl_gb6 <- fl |> 
  flash_backfit() 
allplots[[8]] <- plot_fl(fl_gb6, c(2:4, 1), "EBNMF (backfit)") 
allplots[[8]]
```

Remove background factor and refit:

```{r}
fl_gb6_refit <- fl_gb6 |>
  flash_factors_remove(kset = 1) |>
  flash_backfit() |>
  flash_greedy(Kmax = 4, ebnm_fn = ebnm_point_exponential) |>
  flash_backfit()
allplots[[13]] <- plot_fl(fl_gb6_refit, 1:5, "EBNMF (refit)") 
allplots[[13]]
fl_gb6$elbo
fl_gb6_refit$elbo
```

```{r}
fl_final <- flash(Y, greedy_Kmax = 6, ebnm_fn = ebnm_point_exponential, backfit = TRUE) |>
  flash_factors_remove(kset = 1) |>
  flash_backfit() |>
  flash_greedy(Kmax = 6, ebnm_fn = ebnm_point_exponential) |>
  flash_backfit() |>
  flash_greedy(Kmax = 6, ebnm_fn = ebnm_point_exponential) |>
  flash_backfit()
plot_fl(fl_final, 1:4, "EBNMF (final)") 
```


Sparse NMF (K = 3) with approximately correct sparsity setting:

```{r}
sparse_nmf <- readMat("matlab/simdata_scenario2_nmf_sW=0.3.mat")
allplots[[10]] <- plot_nmf(sparse_nmf, c(3, 1, 2), "SpNMF (good sparsity)")
allplots[[10]]
```



Sparse NMF (K = 3) with sparsity set too low:

```{r}
sparse_nmf <- readMat("matlab/simdata_scenario2_nmf_sW=0.2.mat")
allplots[[9]] <- plot_nmf(sparse_nmf, c(3, 2, 1), "SpNMF (low sparsity)")
allplots[[9]]
```

Sparse NMF (K = 3) with sparsity set too high:

```{r}
sparse_nmf <- readMat("matlab/simdata_scenario2_nmf_sW=0.4.mat")
allplots[[11]] <- plot_nmf(sparse_nmf, c(2, 3, 1), "SpNMF (high sparsity)")
allplots[[11]]
```

Sparse NMF (K = 6) with approximately correct sparsity setting:

```{r}
sparse_nmf <- readMat("matlab/simdata_scenario2_nmf_k=6.mat")
allplots[[12]] <- plot_nmf(sparse_nmf, c(2, 6, 4, 3, 5, 1), "SpNMF (good sparsity)")
allplots[[12]]
```

```{r}
fl_iter <- flash_init(Y)
keep_going <- TRUE
while(keep_going) {
  n <- fl_iter$n_factors
  fl_iter <- fl_iter |>
    flash_greedy(ebnm_fn = ebnm_point_exponential) |>
    flash_backfit(maxiter = 10)
  if (fl_iter$n_factors == n) {
    keep_going <- FALSE
  }
}
fl_iter <- flash_backfit(fl_iter)
allplots[[13]] <- plot_fl(fl_iter, c(2, 3, 1, 4:6), "EBNMF (always backfit)")
allplots[[13]]
```

All plots:

```{r fig.height=6, fig.width=8}
p1 <- plot_grid(plotlist = allplots[c(1, 2, 5, 6, 11, 10)], nrow = 3, ncol = 2)
p1
```

```{r fig.height=6, fig.width=8}
p2 <- plot_grid(plotlist = allplots[c(1, 3, 7, 8, 4, 12)], nrow = 3, ncol = 2)
p2
```

ELBOs:

```{r}
fl_b$elbo
fl_gb3$elbo
fl_gb6$elbo
```

